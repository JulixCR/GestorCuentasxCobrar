@page "/login"
@using CxC.UI.Models
@using Radzen
@attribute [AllowAnonymous]
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@inject NotificationService NotificationService

<div class="row justify-content-center mt-5">
    <div class="col-md-6 col-lg-5">
        <RadzenCard Style="box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="text-center mb-4">
                <h3>Iniciar sesión</h3>
                <p class="text-muted">Use sus credenciales de SQL Server</p>
            </div>

            <RadzenTemplateForm Data="@model" Submit="OnSubmit">
                <div class="mb-3">
                    <label class="form-label">Usuario</label>
                    <RadzenTextBox Name="Usuario" @bind-Value="model.Usuario" Style="width:100%" Placeholder="usuario" />
                    <RadzenRequiredValidator Component="Usuario" Text="Ingrese el usuario" Popup="true" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Contraseña</label>
                    <RadzenPassword Name="Contrasena" @bind-Value="model.Contrasena" Style="width:100%" Placeholder="contraseña" />
                    <RadzenRequiredValidator Component="Contrasena" Text="Ingrese la contraseña" Popup="true" />
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <RadzenButton Text="Ingresar" ButtonStyle="ButtonStyle.Primary" Type="ButtonType.Submit" BusyText="Validando..." Busy="isSubmitting" Icon="login" />
                    <RadzenButton Text="Limpiar" ButtonStyle="ButtonStyle.Light" Click="Reset" Disabled="isSubmitting" Icon="refresh" />
                </div>
            </RadzenTemplateForm>
        </RadzenCard>
    </div>
</div>

@code {
    private readonly LoginModel model = new();
    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }
    private bool isSubmitting;

    private async Task OnSubmit()
    {
        isSubmitting = true;
        var userSession = await AuthService.SignInAsync(model.Usuario, model.Contrasena);
        isSubmitting = false;

        if (userSession is null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "No autorizado",
                Detail = "Verifique el usuario y la contraseña",
                Duration = 4000
            });
            return;
        }

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Bienvenido",
            Detail = userSession.Name,
            Duration = 2500
        });

        var target = string.IsNullOrWhiteSpace(ReturnUrl) ? "/" : ReturnUrl;
        NavigationManager.NavigateTo(target, true);
    }

    private void Reset()
    {
        model.Usuario = string.Empty;
        model.Contrasena = string.Empty;
    }
}
